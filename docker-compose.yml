services:
  tempo:
    image: grafana/tempo:latest
    command: [ "-config.file=/etc/tempo.yaml" ]
    volumes:
      - ./tempo.yaml:/etc/tempo.yaml
    ports:
      - "4317:4317"
      - "4318:4318"
      - "3200:3200"

  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana:latest
    ports: ["3001:3000"]
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    volumes:
      - ./grafana-provisioning:/etc/grafana/provisioning

  d-fast:
    build: ./d
    command: uvicorn app:app --host 0.0.0.0 --port 8000
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://tempo:4318
      - OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf
      - OTEL_SERVICE_NAME=svc-d-fast
      - DEVICE_TYPE=fast
    depends_on: [tempo]
    ports: ["8002:8000"]  # Fast device on port 8002

  d-slow:
    build: ./d
    command: uvicorn app:app --host 0.0.0.0 --port 8000
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://tempo:4318
      - OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf
      - OTEL_SERVICE_NAME=svc-d-slow
      - DEVICE_TYPE=slow
      - SLOW_MULTIPLIER=3.3  # Makes 3s â†’ ~10s (worst-case scenario)
    depends_on: [tempo]
    ports: ["8003:8000"]  # Slow device on port 8003

  c:
    build: ./c
    env_file:
      - ./config/baseline.env  # Default to baseline, can override with tunable.env
    environment:
      - D_FAST_URL=http://d-fast:8000
      - D_SLOW_URL=http://d-slow:8000
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://tempo:4318
      - OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf
      - OTEL_SERVICE_NAME=svc-c
    depends_on: [d-fast, d-slow, tempo]

  # Service B - Python FastAPI (original)
  b:
    build: ./b
    command: uvicorn app:app --host 0.0.0.0 --port 8080
    env_file:
      - ./config/baseline.env  # Default to baseline, can override with tunable.env
    environment:
      - C_TARGET=c:50051
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://tempo:4318
      - OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf
      - OTEL_SERVICE_NAME=svc-b
    depends_on: [c, tempo]
    ports: ["8080:8080", "8081:8081"]
    profiles: ["python"]
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # Service B - Java Spring Boot (alternative implementation)  
  b-java:
    build: ./b-java
    env_file:
      - ./config/baseline.env
    environment:
      - OTEL_SERVICE_NAME=svc-b
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://tempo:4318
      - OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf
      - APP_C_TARGET=c:50051
    depends_on: [c, tempo]
    ports: ["8080:8080", "8081:8081"] 
    profiles: ["java"]